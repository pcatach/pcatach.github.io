<head>
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
</head>

<body>
  <div id="map" style="width: 100%; height: 100%"></div>
  <script type="module">
    async function fetchWikipediaSummary(query) {
        const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;
        console.log(url);
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            return data.extract; // The summary text
        } catch (error) {
            console.error('Error fetching Wikipedia summary:', error);
            return 'No summary available';
        }
    }

    function getFeatures(map, point) {
      let params = [{ layers: relevantLayers }]
      if (point != undefined) {
        params.unshift(point)
      }
      console.log("Params:", params);
      const features = map.queryRenderedFeatures(...params);
      console.log("Features:", features);
      return features.map((feature) => feature.properties.name_int);
    }

    function getLongAndLat() {
      return new Promise((resolve, reject) =>
        navigator.geolocation.getCurrentPosition(resolve, reject)
      );
    }


    console.log("Loading position");
    const currentPosition = await getLongAndLat();
    const coords = [currentPosition.coords.longitude, currentPosition.coords.latitude];
    console.log(`Got position ${coords}`);

    console.log("Loading map");
    window.map = new maplibregl.Map({
      style: 'https://tiles.openfreemap.org/styles/liberty',
      center: coords,
      zoom: 15,
      container: 'map',
    });
    const map = window.map

    const relevantLayers = ['poi_r20', 'poi_r7', 'poi_r1', 'poi_transit', 'label_other', 'label_village', 'label_town', 'label_state', 'label_city', 'label_city_capital', 'label_country_3', 'label_country_2', 'label_country_1']

    map.on("load", () => {
      const featureNames = getFeatures(map);
    })

    map.on("click", async (event) => {
      const featureNames = getFeatures(map, event.point);

      if (featureNames.length > 0) {
        const summary = await fetchWikipediaSummary(featureNames[0]);
        alert(summary);
      }

    })
  </script>
</body>